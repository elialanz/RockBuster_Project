/* 
Calculates the average payment made by each of the top 5 highest-spending customers.  
The subquery identifies the top 5 customers by total amount paid across selected cities.  
The main query joins payments again to compute each customerâ€™s average transaction value.  
Results show customer name, ID, total spent, and their average payment.  
Ordered by customer ID for clarity.  
*/

SELECT
	total_amount_paid.customer_id,
	total_amount_paid.customer_firstname,
	total_amount_paid.customer_lastname,
	AVG(PA.amount) AS average_amount_paid,
	total_amount_paid.customer_total_amount
FROM
	(SELECT
	CU.customer_id,
	CU.first_name AS customer_firstname,
	CU.last_name AS customer_lastname,
	CI.city AS customer_city,
	CO.country AS customer_country,
	SUM(PA.amount) AS customer_total_amount
FROM
	customer CU
INNER JOIN
	address AD ON CU.address_id = AD.address_id
INNER JOIN
	city CI ON AD.city_id = CI.city_id
INNER JOIN
	country CO ON CI.country_id = CO.country_id
INNER JOIN
	payment PA ON CU.customer_id = PA.customer_id
WHERE
	CI.city IN ('Aurora', 'Acua', 'Citrus Heights',
	'Iwaki', 'Ambattur', 'Shanwei', 'So Leopoldo',
	'Teboksary', 'Tianjin', 'Cianjur')
GROUP BY
	CU.customer_id,
	CU.first_name,
	CU.last_name,
	CI.city,
	CO.country
ORDER BY
	customer_total_amount DESC
LIMIT 5) AS total_amount_paid
INNER JOIN
	payment PA ON total_amount_paid.customer_id = PA.customer_id
GROUP BY
	total_amount_paid.customer_firstname,
	total_amount_paid.customer_lastname,
	total_amount_paid.customer_id,
	total_amount_paid.customer_total_amount
ORDER BY
	total_amount_paid.customer_id;
